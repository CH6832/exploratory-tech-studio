<!DOCTYPE html>
<html>
  <head>
    <title>Github Profile Finder</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <style>
      img {
        width: 100%;
      }
      .profile-container {
        margin-bottom: 20px;
      }
      .btn-dark {
        background-color: #343a40;
        color: #fff;
      }
      .btn-dark:hover {
        background-color: #23272b;
      }
      .dark-mode {
        background-color: #212529;
        color: #ffffff;
      }
      .dark-mode .panel {
        background-color: #343a40;
      }
      .dark-mode .panel-heading {
        background-color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form id="userForm">
        <div class="form-group">
          <label>Search Github Users:</label>
          <input type="text" id="searchQuery" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
        <button type="button" id="toggleDarkMode" class="btn btn-dark">
          Toggle Dark Mode
        </button>
        <button type="button" id="exportData" class="btn btn-success">
          Export Data
        </button>
      </form>
      <br /><br />
      <div id="profiles"></div>
    </div>

    <script>
      let profilesData = [];

      function searchProfiles(e) {
        e.preventDefault();
        console.log("Searching...");

        var searchQuery = document.getElementById("searchQuery").value.trim();
        if (!searchQuery) {
          console.log("Please enter a search query.");
          return;
        }

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (xhttp.readyState == 4 && xhttp.status == 200) {
            var users = JSON.parse(xhttp.responseText);
            profilesData = []; // Reset profiles data
            displayProfiles(users);
          }
        };
        xhttp.open(
          "GET",
          "https://api.github.com/search/users?q=" + searchQuery,
          true
        );
        xhttp.send();
      }

      function displayProfiles(users) {
        var profilesContainer = document.getElementById("profiles");
        profilesContainer.innerHTML = "";

        users.items.forEach(function (user) {
          fetch(user.url) // Fetch additional user data for advanced features
            .then((response) => response.json())
            .then((userData) => {
              // Fetch repositories
              fetch(userData.repos_url)
                .then((response) => response.json())
                .then((repos) => {
                  // Sort repositories by stars and forks
                  repos.sort((a, b) => b.stargazers_count - a.stargazers_count);
                  let topStarredRepos = repos.slice(0, 3);

                  repos.sort((a, b) => b.forks_count - a.forks_count);
                  let topForkedRepos = repos.slice(0, 3);

                  // Calculate language stats
                  let languageStats = {};
                  repos.forEach((repo) => {
                    fetch(repo.languages_url)
                      .then((response) => response.json())
                      .then((languages) => {
                        for (let lang in languages) {
                          if (languageStats[lang]) {
                            languageStats[lang] += languages[lang];
                          } else {
                            languageStats[lang] = languages[lang];
                          }
                        }

                        let sortedLangs = Object.entries(languageStats).sort(
                          (a, b) => b[1] - a[1]
                        );
                        let langHtml = sortedLangs
                          .map(
                            ([lang, bytes]) =>
                              `<li>${lang} (${Math.round(
                                bytes / 1024
                              )} KB)</li>`
                          )
                          .join("");

                        profilesData.push({
                          login: user.login,
                          name: userData.name || "N/A",
                          location: userData.location || "N/A",
                          followers: userData.followers,
                          following: userData.following,
                          public_repos: userData.public_repos,
                          public_gists: userData.public_gists,
                          blog: userData.blog || "N/A",
                          updated_at: userData.updated_at,
                          html_url: user.html_url,
                          top_starred_repos: topStarredRepos,
                          top_forked_repos: topForkedRepos,
                          language_stats: langHtml,
                        });

                        var topStarredHtml = topStarredRepos
                          .map(
                            (repo) =>
                              `<li><a href="${repo.html_url}" target="_blank">${repo.name}</a> (${repo.stargazers_count} stars)</li>`
                          )
                          .join("");

                        var topForkedHtml = topForkedRepos
                          .map(
                            (repo) =>
                              `<li><a href="${repo.html_url}" target="_blank">${repo.name}</a> (${repo.forks_count} forks)</li>`
                          )
                          .join("");

                        var profileHTML = `<div class="panel panel-default profile-container">
                                                <div class="panel-heading">
                                                    <h3 class="panel-title">${
                                                      user.login
                                                    }</h3>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <img src="${
                                                              user.avatar_url
                                                            }" alt="${
                          user.login
                        }">
                                                        </div>
                                                        <div class="col-md-9">
                                                            <p><strong>Name:</strong> ${
                                                              userData.name ||
                                                              "N/A"
                                                            }</p>
                                                            <p><strong>Location:</strong> ${
                                                              userData.location ||
                                                              "N/A"
                                                            }</p>
                                                            <p><strong>Followers:</strong> ${
                                                              userData.followers
                                                            }</p>
                                                            <p><strong>Following:</strong> ${
                                                              userData.following
                                                            }</p>
                                                            <p><strong>Public Repos:</strong> ${
                                                              userData.public_repos
                                                            }</p>
                                                            <p><strong>Public Gists:</strong> ${
                                                              userData.public_gists
                                                            }</p>
                                                            <p><strong>Top Starred Repositories:</strong></p>
                                                            <ul>${topStarredHtml}</ul>
                                                            <p><strong>Top Forked Repositories:</strong></p>
                                                            <ul>${topForkedHtml}</ul>
                                                            <p><strong>Language Stats:</strong></p>
                                                            <ul>${
                                                              profilesData[
                                                                profilesData.length -
                                                                  1
                                                              ].language_stats
                                                            }</ul>
                                                            <p><strong>Recent Activity:</strong> ${
                                                              userData.updated_at
                                                            }</p>
                                                            <br>
                                                            <a class="btn btn-default" target="_blank" href="${
                                                              user.html_url
                                                            }">Visit Github</a>
                                                            ${
                                                              userData.blog
                                                                ? `<a class="btn btn-default" target="_blank" href="${userData.blog}">Visit Website</a>`
                                                                : ""
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`;
                        profilesContainer.innerHTML += profileHTML;
                      });
                  });
                });
            });
        });
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
      }

      function exportData() {
        let csvContent = "data:text/csv;charset=utf-8,";
        const header = [
          "Login",
          "Name",
          "Location",
          "Followers",
          "Following",
          "Public Repos",
          "Public Gists",
          "Website",
          "Last Updated",
          "Profile URL",
          "Top Starred Repositories",
          "Top Forked Repositories",
          "Language Stats",
        ];
        csvContent += header.join(",") + "\n";

        profilesData.forEach((profile) => {
          const topStarredRepos = profile.top_starred_repos
            .map((repo) => `${repo.name} (${repo.stargazers_count} stars)`)
            .join(" | ");
          const topForkedRepos = profile.top_forked_repos
            .map((repo) => `${repo.name} (${repo.forks_count} forks)`)
            .join(" | ");
          const langStats = profile.language_stats.replace(/<\/?li>/g, ""); // Simplify HTML for CSV
          const row = [
            profile.login,
            profile.name,
            profile.location,
            profile.followers,
            profile.following,
            profile.public_repos,
            profile.public_gists,
            profile.blog,
            profile.updated_at,
            profile.html_url,
            topStarredRepos,
            topForkedRepos,
            langStats,
          ];
          csvContent += row.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "github_profiles.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      document
        .getElementById("userForm")
        .addEventListener("submit", searchProfiles, false);
      document
        .getElementById("toggleDarkMode")
        .addEventListener("click", toggleDarkMode, false);
      document
        .getElementById("exportData")
        .addEventListener("click", exportData, false);
    </script>
  </body>
</html>
